"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[2246],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=u(n),h=o,y=d["".concat(l,".").concat(h)]||d[h]||p[h]||a;return n?r.createElement(y,i(i({ref:t},c),{},{components:n})):r.createElement(y,i({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var u=2;u<a;u++)i[u]=n[u];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3035:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return u},metadata:function(){return c},toc:function(){return p},default:function(){return h}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),i=n(4996),s=["components"],l={title:"Proxying Plausible through Cloudflare"},u=void 0,c={unversionedId:"proxy/guides/cloudflare",id:"proxy/guides/cloudflare",title:"Proxying Plausible through Cloudflare",description:"You can use Cloudflare Workers to proxy your Plausible Analytics requests. Cloudflare Workers offers free service for up to 100,000 requests per day.",source:"@site/docs/proxy/guides/cloudflare.md",sourceDirName:"proxy/guides",slug:"/proxy/guides/cloudflare",permalink:"/docs/proxy/guides/cloudflare",editUrl:"https://github.com/plausible/docs/edit/master/docs/proxy/guides/cloudflare.md",tags:[],version:"current",frontMatter:{title:"Proxying Plausible through Cloudflare"},sidebar:"someSidebar",previous:{title:"Adblockers and using a proxy for analytics",permalink:"/docs/proxy/introduction"},next:{title:"Proxying Plausible through Akamai",permalink:"/docs/proxy/guides/akamai"}},p=[{value:"Step 1: Create a worker",id:"step-1-create-a-worker",children:[],level:2},{value:"Step 2 (Optional): You can change your service name",id:"step-2-optional-you-can-change-your-service-name",children:[],level:2},{value:"Step 3: Quick edit the worker",id:"step-3-quick-edit-the-worker",children:[],level:2},{value:"Step 4: Make sure the script is accessible",id:"step-4-make-sure-the-script-is-accessible",children:[],level:2},{value:"Step 5: Integrate a new snippet into your site header",id:"step-5-integrate-a-new-snippet-into-your-site-header",children:[],level:2},{value:"Step 6 (Optional): Run proxy as a subdirectory",id:"step-6-optional-run-proxy-as-a-subdirectory",children:[],level:2}],d={toc:p};function h(e){var t=e.components,n=(0,o.Z)(e,s);return(0,a.kt)("wrapper",(0,r.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"You can use Cloudflare Workers to proxy your Plausible Analytics requests. Cloudflare Workers offers free service for up to 100,000 requests per day.\nAll you need to set it up is a free Cloudflare account."),(0,a.kt)("p",null,"Here's the step-by-step process for creating a proxy. It takes only a few minutes and requires no tech know-how or prior experience."),(0,a.kt)("p",null,"Step 0: Sign up for a free Cloudflare account if you don't have an account already and add your site"),(0,a.kt)("h2",{id:"step-1-create-a-worker"},"Step 1: Create a worker"),(0,a.kt)("p",null,"In your Cloudflare account, click on the 'Workers' section in the sidebar. Then click on the 'Create a Service' button to start configuring your proxy. "),(0,a.kt)("img",{alt:"Workers section of your Cloudflare account",src:(0,i.Z)("img/cloudflare-workers.png")}),(0,a.kt)("h2",{id:"step-2-optional-you-can-change-your-service-name"},"Step 2 (Optional): You can change your service name"),(0,a.kt)("p",null,"This is optional but you can change the service name to give your worker a more meaningful name. Do avoid words like 'plausible', 'analytics', 'tracking', 'stats', etc. as they may be blocked. It's also fine to keep the random name that Cloudflare generates by default. "),(0,a.kt)("img",{alt:"Rename your worker",src:(0,i.Z)("img/cloudflare-rename-work-dash.png")}),(0,a.kt)("p",null,"In the 'Select a starter' section, keep the 'Introduction (HTTP Handler)' as your selection and then click on the 'Create service' button."),(0,a.kt)("img",{alt:"Create service",src:(0,i.Z)("img/cloudflare-create-service.png")}),(0,a.kt)("h2",{id:"step-3-quick-edit-the-worker"},"Step 3: Quick edit the worker"),(0,a.kt)("p",null,"Click on the 'Quick edit' where you can edit the code for your worker:"),(0,a.kt)("img",{alt:"Quick edit the worker",src:(0,i.Z)("img/cloudflare-quick-edit.png")}),(0,a.kt)("p",null,"Then you will see a screen that looks like this: "),(0,a.kt)("img",{alt:"Paste the code",src:(0,i.Z)("img/cloudflare-paste-code.png")}),(0,a.kt)("p",null,"Remove the default code that Cloudflare presents on the left side of the screen and paste the code that we present below instead."),(0,a.kt)("p",null,"We recommend you change the folder name in the first two lines in the code below. This makes your proxy more difficult to discover and block. We especially recommend you change the folder name in the two lines if you're not hosting your site on the Cloudflare CDN."),(0,a.kt)("p",null,"In the ",(0,a.kt)("strong",{parentName:"p"},"ScriptName")," line, change the ",(0,a.kt)("inlineCode",{parentName:"p"},"/js/")," to whatever you wish. Say ",(0,a.kt)("inlineCode",{parentName:"p"},"/your-folder-name/"),". Then the location in the code would be ",(0,a.kt)("inlineCode",{parentName:"p"},"/your-folder-name/script.js"),". "),(0,a.kt)("p",null,"In the ",(0,a.kt)("strong",{parentName:"p"},"Endpoint")," line, change the ",(0,a.kt)("inlineCode",{parentName:"p"},"/api/")," to whatever you want. It can be the same as above but you can also choose something different. If you choose ",(0,a.kt)("inlineCode",{parentName:"p"},"/your-folder-name/"),", then the full location would be ",(0,a.kt)("inlineCode",{parentName:"p"},"/your-folder-name/event"),". "),(0,a.kt)("p",null,"Do avoid words like 'plausible', 'analytics', 'tracking', 'stats', etc. as they may be blocked."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const ScriptName = '/js/script.js';\nconst Endpoint = '/api/event';\n\nconst ScriptWithoutExtension = ScriptName.replace('.js', '')\n\naddEventListener('fetch', event => {\n    event.passThroughOnException();\n    event.respondWith(handleRequest(event));\n})\n\nasync function handleRequest(event) {\n  const pathname = new URL(event.request.url).pathname\n  const [baseUri, ...extensions] = pathname.split('.')\n\n  if (baseUri.endsWith(ScriptWithoutExtension)) {\n      return getScript(event, extensions)\n  } else if (pathname.endsWith(Endpoint)) {\n      return postData(event)\n  }\n  return new Response(null, { status: 404 })\n}\n\nasync function getScript(event, extensions) {\n    let response = await caches.default.match(event.request);\n    if (!response) {\n        response = await fetch(\"https://plausible.io/js/plausible.\" + extensions.join(\".\"));\n        event.waitUntil(caches.default.put(event.request, response.clone()));\n    }\n    return response;\n}\n\nasync function postData(event) {\n    const request = new Request(event.request);\n    request.headers.delete('cookie');\n    return await fetch(\"https://plausible.io/api/event\", request);\n}\n")),(0,a.kt)("p",null,"Once you've added the above code to the worker, you can click on the 'Save and Deploy' button."),(0,a.kt)("h2",{id:"step-4-make-sure-the-script-is-accessible"},"Step 4: Make sure the script is accessible"),(0,a.kt)("p",null,"Now, the Plausible script should be accessible at the following URL:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"https://your-worker-name.your-cloudflare-username.workers.dev/your-folder-name/script.js\n")),(0,a.kt)("p",null,"If you can load this URL and see some Javascript code, you should be good to go to the following step."),(0,a.kt)("h2",{id:"step-5-integrate-a-new-snippet-into-your-site-header"},"Step 5: Integrate a new snippet into your site header"),(0,a.kt)("p",null,"Once you have the URL for your script, you can replace your Plausible Analytics script tag in the Header (",(0,a.kt)("inlineCode",{parentName:"p"},"<head>"),") section of your site with the proxied snippet. This is how the new snippet should look like (make sure to edit it to have the correct domain name of your site and the correct URL to the proxied file):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-html"},'<script defer data-domain="yourdomain.com" data-api="https://your-worker-name.your-cloudflare-username.workers.dev/your-folder-name/event" src="https://your-worker-name.your-cloudflare-username.workers.dev/your-folder-name/script.js"><\/script>\n')),(0,a.kt)("p",null,"Are you using our extensions such as hash-based routing, page exclusions or outbound link click tracking? Change the file name from ",(0,a.kt)("inlineCode",{parentName:"p"},"script.js")," to the script you want to use: ",(0,a.kt)("inlineCode",{parentName:"p"},"script.hash.js"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"script.exclusions.js")," or ",(0,a.kt)("inlineCode",{parentName:"p"},"script.outbound-links.js"),". Want to use more than one extension? You can chain them like this: ",(0,a.kt)("inlineCode",{parentName:"p"},"script.hash.exclusions.outbound-links.js"),". You just need to change the script name in the snippet that you insert into your site, no need to change the code for the worker."),(0,a.kt)("p",null,"That's it! You're now counting your website stats using a proxy."),(0,a.kt)("h2",{id:"step-6-optional-run-proxy-as-a-subdirectory"},"Step 6 (Optional): Run proxy as a subdirectory"),(0,a.kt)("p",null,"If you're hosting your site on the Cloudflare CDN, you can run the proxy as a subdirectory installation to avoid a third-party\nrequest to the ",(0,a.kt)("inlineCode",{parentName:"p"},"workers.dev")," domain. This is completely optional but it can make your URLs look much cleaner and avoid third-party\nrequests."),(0,a.kt)("p",null,"In your Cloudflare account, click on the 'Workers' section in the sidebar. Then, click on the worker that you have just created and in the 'Triggers' tab, click the 'Add route' button. "),(0,a.kt)("img",{alt:"Adding a route in your Cloudflare account",src:(0,i.Z)("img/cloudflare-workers-dash.png")}),(0,a.kt)("p",null,"Next, enter the URL prefix where you would like to install Plausible. In this example, we'll install the proxy on the ",(0,a.kt)("inlineCode",{parentName:"p"},"example.com")," domain and we'll use ",(0,a.kt)("inlineCode",{parentName:"p"},"qwerty")," as the subdirectory name. You can choose any name for the subdirectory but it's a good idea to avoid words like 'analytics' and 'tracking'."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Route: ",(0,a.kt)("inlineCode",{parentName:"li"},"*example.com/qwerty/*"))),(0,a.kt)("img",{alt:"A new route",src:(0,i.Z)("img/cloudflare-add-route.png")}),(0,a.kt)("p",null,"Click on the 'Add route' button. After clicking 'Add route', the script should be accessible at the subdirectory URL of your site: ",(0,a.kt)("inlineCode",{parentName:"p"},"https://example.com/qwerty/your-folder-name/script.js"),". "),(0,a.kt)("p",null,"At this point you can change your Plausible script tag in your site header to reference the new URL. It's also important to specify the ",(0,a.kt)("inlineCode",{parentName:"p"},"data-api")," attribute to make sure data is sent through the worker as well. The new snippet in your site header should look like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-html"},'<script defer data-domain="yourdomain.com" data-api="/qwerty/your-folder-name/event" src="/qwerty/your-folder-name/script.js"><\/script>\n')),(0,a.kt)("p",null,"Notice that since the script tag is installed on the same domain as the website itself, there's no need to specify the hostname in ",(0,a.kt)("inlineCode",{parentName:"p"},"src")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"data-api")," attributes. A relative path will work just fine."))}h.isMDXComponent=!0}}]);